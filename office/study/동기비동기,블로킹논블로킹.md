# 동기/비동기, 블로킹/논블로킹



### 📍FaspAPI, uvicorn 비동기 메커니즘 이해하기

------

**#동기/비동기 & 블로킹/논블로킹**

- 동기/비동기 ➡︎ 작업 완료 여부를 신경 써서 작업을 순차적으로 수행할지 아닌지

    - 비동기의 성능 이점

        - 느린 작업이 발생할 때, 기다리지 않고 다른 작업을 동시에 처리하여 멀티 작업을 진행할 수 있기 때문에, 전반적인 시스템 성능 향상에 도움을 줄 수 있음

    - 작업 순서 처리 차이

        - 동기 작업은 요청한 작업에 대해 순서가 지켜지는 것 비동기 작업은 순서가 지켜지지 않을 수 있는 것

        ![Untitled](C:/Users/tritech-fall/Desktop/TIL/office/study/%EB%8F%99%EA%B8%B0%EB%B9%84%EB%8F%99%EA%B8%B0,%EB%B8%94%EB%A1%9C%ED%82%B9%EB%85%BC%EB%B8%94%EB%A1%9C%ED%82%B9.assets/Untitled.png)

- 블로킹/논블로킹 ➡︎ 현재 작업이 block(차단, 대기) 되는지 아닌지

    ![Untitled](C:/Users/tritech-fall/Desktop/TIL/office/study/%EB%8F%99%EA%B8%B0%EB%B9%84%EB%8F%99%EA%B8%B0,%EB%B8%94%EB%A1%9C%ED%82%B9%EB%85%BC%EB%B8%94%EB%A1%9C%ED%82%B9.assets/Untitled-1692332602071-2.png)

    

<aside>💡 비동기와 논블로킹의 차이점? ➡︎ 작업의 실행과 결과 처리의 타이밍에 있음

비동기 : 작업의 실행과 결과 처리를 분리하여 비동기적으로 처리 논블로킹 : 작업의 실행과 결과 처리를 분리하지 않고, 다음 작업으로 진행하면서 작업이 완료될 때까지 기다리지 않음

따라서, 비동기는 시간이 오래 걸리는 작업을 효율적으로 다룰 수 있고, 논블로킹은 다음 작업으로의 전환을 빠르게 수행할 수 있어 시스템 자원을 효율적으로 활용할 수 있음





- 제어권

    - 함수의 코드나 프로세스의 실행 흐름을 제어할 수 있는 권리 같은 것

    - Blocking

        ![kkk.png](C:/Users/tritech-fall/Desktop/TIL/office/study/%EB%8F%99%EA%B8%B0%EB%B9%84%EB%8F%99%EA%B8%B0,%EB%B8%94%EB%A1%9C%ED%82%B9%EB%85%BC%EB%B8%94%EB%A1%9C%ED%82%B9.assets/kkk.png)

        - 설명
            1. A 함수가 B 함수를 호출하면 B에게 제어권이 넘어감
            2. 제어권을 받은 B는 함수를 실행
            3. 이때 A는 B에게 제어권을 넘겼기 때문에 A 함수 실행을 잠시 멈춤(Blocking)
            4. B 함수가 실행이 끝나면 자신을 호출한 A에게 제어권을 돌려줌
            5. 제어권을 다시 받은 A 함수는 다음 작업을 실행함

    - Non-Blocking

        ![Untitled](C:/Users/tritech-fall/Desktop/TIL/office/study/%EB%8F%99%EA%B8%B0%EB%B9%84%EB%8F%99%EA%B8%B0,%EB%B8%94%EB%A1%9C%ED%82%B9%EB%85%BC%EB%B8%94%EB%A1%9C%ED%82%B9.assets/Untitled-1692332680333-6.png)

        - 설명
            1. A 함수가 B 함수를 호출
            2. 호출된 B 함수는 실행되지만, 제어권은 A 함수가 그대로 가지고 있음
            3. A 함수는 제어권을 가지고 있기 때문에 B 함수를 호출한 이후에도 자신의 코드를 계속 실행함

- 조합

    ![Untitled](C:/Users/tritech-fall/Desktop/TIL/office/study/%EB%8F%99%EA%B8%B0%EB%B9%84%EB%8F%99%EA%B8%B0,%EB%B8%94%EB%A1%9C%ED%82%B9%EB%85%BC%EB%B8%94%EB%A1%9C%ED%82%B9.assets/Untitled-1692332701409-8.png)

    - Sync Blocking(동기 + 블로킹)

        - 간단한 작업이나 작업량이 적은 경우 적합

    - Async Blocking(비동기 + 블로킹)

        - 실무에서 거의 쓰이지 않음

    - Sync Non-Blocking(동기 + 논블로킹)

        - 예) 게임 로딩 화면

            ![Untitled](C:/Users/tritech-fall/Desktop/TIL/office/study/%EB%8F%99%EA%B8%B0%EB%B9%84%EB%8F%99%EA%B8%B0,%EB%B8%94%EB%A1%9C%ED%82%B9%EB%85%BC%EB%B8%94%EB%A1%9C%ED%82%B9.assets/Untitled-1692332724717-10.png)

    - Async Non-Blocking(비동기 + 논블로킹)

        - 대용량 데이터를 처리하거나 많은 요청을 처리하는 서비스에 적합

**#스레드(thread)**

- 프로세스 내에서 실제로 작업을 수행하는 주체를 의미
- 모든 프로세스에는 한 개 이상의 스레드가 존재하여 작업 수행

**#ASGI 전체 구조**

![uvicorn.png](C:/Users/tritech-fall/Desktop/TIL/office/study/%EB%8F%99%EA%B8%B0%EB%B9%84%EB%8F%99%EA%B8%B0,%EB%B8%94%EB%A1%9C%ED%82%B9%EB%85%BC%EB%B8%94%EB%A1%9C%ED%82%B9.assets/uvicorn.png)

[ASGI Framework]FastAPI - starlette - [ASGI Server]uvicorn - uvloop(cython) - libuv(cpp)

- uvicorn을 ASGI 서버로 사용해 단일 워커와 복수 워커로 구분해 도식한 것
- uvicorn 자체로도 uwsgi처럼 워커를 지정해 구동할 수 있지만, 복수의 워커를 사용할 경우 gunicorn에 워커 클래스를 지정해 좀 더 안정적인 환경에서 구동하는 것을 추천함
- uvloop는 python bulit-in asyncio의 event loop를 대체 가능한 것으로, libuv를 사용하며 cython으로 구현되어 고속으로 동작함

**#ASGI(Asyncronous Server Gateway Interface)**

- 비동기 서버 게이트웨이 인터페이스. 요청에 대해 비동기적으로 처리할 수 있음

- application 함수 객체를 정의함. WSGI와 다른 점은 async 함수이며 매개변수가 3개라는 것

    - `scope` : 현재 요청에 대한 정보가 포함된 사전
    - `send` : 애플리케이션이 클라이언트로 메시지를 돌려보낼 수 있게 해주는 async callable(함수)
    - `receive` : 애플리케이션이 클라이언트로부터 메시지를 수신할 수 있게 해주는 async callable

- 예시

    - 코드

        ```cpp
        async def application(scope, receive, send):
        		await send({
        				'type': 'http.response.start',
        				'status': 200,
        				'headers': [
        						[b'content-type', b'text/plain'],
        				],
        		})
        		await send({
        				'type': 'http.response.body',
        				'body': b'Hello, world',
        		})
        ```

- 장점

    - 함수 전반에서 비동기 메타포를 사용함
    - 다른 많은 연결의 application 및 send 호출과 동시에 교차가 가능함
        - 함수 자체는 async이며 HTTP 헤더와 응답 본문을 별도의 두 가지 await send() 명령으로 보냄. 따라서 함수 자체와 이 함수의 send 명령은 아무것도 차단하지 않음

**#async def와 def의 차이**

- 비동기 처리 라이브러리의 경우 async/await을 사용하고, 그렇지 않으면 def를 사용 권장(FastAPI 공식 문서)

|           | 차이점                                                       |
| --------- | ------------------------------------------------------------ |
| async def | 외부 스레드 풀에서 실행하지 않아 블록킹 됨                   |
| def       | 외부 스레드 풀에서 다이렉트로 실행 → 서버가 블록킹 되지 않음 |

💡 ‘외부 스레드 풀’이란 FastAPI가 가지고 있는 스레드를 의미



**#uvicorn**

- 비동기 인터페이스를 통해 구현된 ASGI 웹 서버
- libuv를 기반으로 cython으로 구현된 uvloop를 사용해 이벤트 루프를 구현
- 별도의 배포 준비가 필요 없음
- 장점
    - 빠른 속도
    - 간단한 코드
    - 적은 버그

